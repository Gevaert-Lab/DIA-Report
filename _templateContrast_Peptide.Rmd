
```{r peptide_contras}

label_work <- gsub('Group','',label)
  label_work_f <- gsub(' ','_',label_work)

library(plotly)
ggplotly(data$volcano)


#pdf(file= file.path(path,paste0("Volcano",".pdf")), width=10, height=10, res=200, units="in")

pdf(file= file.path(path,paste0("Volcano",".pdf")), paper='A4')

data$volcano2file

invisible(dev.off())

#cat('Differential Expressed Proteins \n')
library(DT)

perc_field <- rowData(pe[['peptideNorm']]) %>% colnames() %>%  stringr::str_subset('perc') 
DT::datatable( data$toptable %>% arrange(adjPval)  ,
             extensions = c('FixedColumns', 'Scroller'),
             options = list(fixedColumns = TRUE, scrollY = 400, scrollX = TRUE,
                            scroller = TRUE, dom = 'Bfrtip', autoWidth = TRUE
             ),
 ) %>% formatStyle(
   'differential_expressed',
   target = 'row',
   textAlign = 'center',
    backgroundColor =  styleEqual(c('UP', 'DOWN'), c('#7fcdbb', '#fec44f')))%>% formatRound(columns=c('logFC'), digits=2) %>%
  formatSignif(columns = c('pval', 'adjPval'), digits = 2) %>%  formatString(columns=perc_field, suffix='%')
  

ttable <- data$toptable %>% arrange(adjPval) %>% dplyr::select(- differential_expressed)
write.csv2(ttable, file= file.path(path,paste0("Toptable",".csv")))


UP <- dim(data$toptable %>% filter(differential_expressed == 'UP'))[1]
DOWN <-  dim(data$toptable %>% filter(differential_expressed == 'DOWN'))[1]
 
if ( UP > 0 | DOWN > 0   ) { 
  log_info('Ho DE peptide')
 cat('Boxplot intensities of the top 10 DE peptides ordered by log2FC')
    ## peptide
    d_l <- data$toptable %>% filter(differential_expressed == 'DOWN') %>% arrange(logFC) %>% head(10)%>%   pull(precursor_id)
    u_l <- data$toptable %>% filter(differential_expressed == 'UP') %>% arrange(logFC) %>% head(10) %>%  pull(precursor_id)

     
   final <- c(d_l,u_l)
   
   #log_info("{paste(final, collapse = ', ')}")
            
   sample_sel <- c(rownames(colData(pe)[colData(pe)$Group == str_split_fixed(label_work,' - ',n=2)[1],] ),
          rownames(colData(pe)[colData(pe)$Group == str_split_fixed(label_work,' - ',n=2)[2],])  ) 
  
   
    ab <- as.data.frame(assay(pe[["peptideNorm"]])[final,sample_sel])
   
    
    
  ann <-  data$toptable  %>%   filter ( precursor_id  %in% final ) %>% dplyr::select(precursor_id  ,logFC,adjPval) %>%  mutate( Peptide_info=  str_wrap( paste(precursor_id,'\n','LogFC:',round(logFC,2),'adjPval',round(adjPval,2) ,sep=' '),width= 15)  ) %>% dplyr::select(  -adjPval)
  
  log_info("{dim(ab)}")
    ab <-  ab %>% rownames_to_column('Precursor') %>% left_join(ann, join_by(Precursor  == precursor_id)) %>%  gather(Sample, Intensity ,- c(Precursor ,Peptide_info,logFC))  %>% left_join( as.data.frame(colData(pe)), join_by( Sample  == SampleName) )
    

   
     dep_plot_crip <- ab %>%
  ggplot( aes(x=Group, y=Intensity, fill=Group )) +
    geom_boxplot() +
    scale_fill_manual( values= c( "#6d0286", "#35B779FF") ) +
    geom_jitter(color="black", size=1, alpha=0.8)  +
     ylab('Peptide Intensity') +
    facet_wrap( . ~ reorder(Peptide_info, logFC), nrow = 4  )
#
     # . ~ Peptide_info
  dep_plot_crip
  
}

```